#!/bin/bash

set -e

dir=$PWD
if [[ ! "$dir/bin/uninstall" -ef "$0" ]]; then
  echo "Please run 'bin/uninstall' from dotfiles root folder"
  exit 1
fi

# Getting dotfiles list into an array
files=( $(find . -maxdepth 1 -name '.*' -type f | sed 's#^\./##') )

for file in ${files[@]}; do
  printf "${file}\t"
  dotfile_path="${dir}/${file}"
  path="${HOME}/${file}"
  # If file exists and it's a symlink
  if [ -L $path ]; then
    if [ $dotfile_path = "$(readlink $path)" ]; then
      unlink $path
      printf "Unlinked. "
      if [ -f "${path}.old" ]; then
        mv "${path}.old" $path
        printf "Old backup file restored.\n"
      else
        printf "No backup file found.\n"
      fi
    else
      printf "It's not linked with Koombea dotfiles\n"
    fi
  else
    # If file exists
    if [ -f $path ]; then
      printf "It's not a symlink\n"
    else
      printf "Does not exist\n"
    fi
  fi
done
