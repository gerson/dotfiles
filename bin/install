#!/bin/bash

set -e

dir=$PWD
if [[ ! "$dir/bin/install" -ef "$0" ]]; then
  echo "Please run 'bin/install' from dotfiles root folder"
  exit 1
fi
# Getting dotfiles list into an array
files=( $(find . -maxdepth 1 -name '.*' -type f | sed 's#^\./##') )

# Sysmlink dotfiles to HOME directory and renaming existing file with .old suffix
for file in ${files[@]}; do
  printf "${file}\t"
  dotfile_path="${dir}/${file}"
  path="${HOME}/${file}"
  # If file exists and it's a symlink
  if [ -L $path ]; then
    printf "Skipped. It already exists\n"
  else
    # If file exists
    if [ -f $path ]; then
      mv $path "${path}.old"
      printf "(Renaming ${file} to ${file}.old)\t"
    fi
    ln -nfs $dotfile_path $path
    printf "Symlinked to ${path}\n"
  fi
done

# INSTALL SUBLIME PACKAGES
# 1.) Search for the installed sublime version
# 2.) Download and copy the file "Package Control.sublime-package" to the “/Installed Packages" folder within Sublime dir.
# 3.) To batch install other packages, copy the file “Package Control.sublime-settings” into the "Packages/User/“ folder.
# 4.) Also, copy the file "Preferences.sublime-settings” into the "Packages/User/“ folder.
download_file(){
  PACKAGE_CONTROL="${PWD}/Package Control.sublime-package"
  if [ -f $PACKAGE_CONTROL ]; then
    echo "Package Control.sublime-package already exists in the dotfile path."
  else
    curl -sS https://packagecontrol.io/Package%22Control.sublime-package > "Package Control.sublime-package"
    echo "Downloading Package Control.sublime-package"
  fi
}

echo_message(){
  case $1 in
    "skip")
      echo "Skipped ${2##*/}. It already exists"
      ;;
    "rename")
      echo "Renaming ${2##*/} to ${2##*/}.old"
      ;;
    "symlink")
      echo "Symlinked to ${2##*/}"
  esac
}

skip_or_symlink_file(){
  if [ -L $2 ]; then
    echo_message "skip" "$2"
  else
    if [ -f $2 ]; then
      mv $2 "${2}.old"
      echo_message "rename" "$2"
    fi
    ln -nfs "$1" "$2"
    echo_message "symlink" "$2"
  fi
}

sublime_2_support(){
  # USER PREFERENCES INSTALLATION SUBLIME 2
  USER_SETTINGS_DIR="$HOME/Library/Application Support/Sublime Text 2/Packages/User"
  PACKAGE_DIR="$HOME/Library/Application Support/Sublime Text 2/Installed Packages"
  SUBLIME_2_DIR="$HOME/Library/Application Support/Sublime Text 2"
  SUBLIME_2_FILES=("Preferences.sublime-settings" "Package Control.sublime-package" "Package Control.sublime-settings")

  #To stop space as element delimiter.
  IFS=""
  regex='sublime-package$'
  download_file
  for filename in ${SUBLIME_2_FILES[*]}; do
    if [[ $filename =~ $regex ]]; then
      DESTINY="${PACKAGE_DIR}/${filename}"
    else
      DESTINY="${USER_SETTINGS_DIR}/${filename}"
    fi
    ORIGIN="${PWD}/${filename}"

    skip_or_symlink_file "$ORIGIN" "$DESTINY"
  done
}

sublime_2_support
